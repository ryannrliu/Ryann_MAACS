---
title: "Homework 2 Report"
output:
  pdf_document: default
  html_document: default
---


## Name

Ryann Liu (rl35976)

### Setup

Read in the data with `read_csv()` and store the data as an R object named `dataset`. Check the data to make sure all of the expected observations and variables are there.


```{r, warning = FALSE, message = FALSE}
## Load the data and any necessary packages here.
library(ggplot2)
library(dplyr)
library(readr)
dataset <- read_csv('maacs.csv.gz')
```

## Part 1

We will first consider the relationship between FEV1 and age. In general, it is expected that as children get older (and hence, larger in size), their FEV1 values should get higher. 

Consider the statement "FEV1 values in children are higher in older children relative to younger children". 

Write a function in R that takes the `dataset` object as an argument and returns `TRUE` if the statement above is true for the dataset and `FALSE` otherwise. 

NOTE: In order to write this function, you will need to translate the statement above into something that can be checked with the data. There are many ways in which you can do that translation correctly and you only need to pick one way here. 

NOTE: For this part, do not use any plots.

```{r, warning = FALSE, message = FALSE}
## Write your function here
check_fev1_age <- function(dataset) {
  if(!all(c("fev1", "age") %in% names(dataset))) {
    stop("Dataset must contain 'fev1' and 'age' columns.")
  }
  df <- dataset[complete.cases(dataset$fev1, dataset$age), ]
  
  if(nrow(df) < 2) {
    return(FALSE) 
  }
  cor_val <- cor(df$age, df$fev1)
  
  return(cor_val > 0)
}
check_fev1_age(dataset)
```


## Part 2

Fit a linear regression model with FEV1 as the outcome and age as a predictor.

How much does FEV1 change for a 1-year increase in the child's age? 

```{r, warning = FALSE, message = FALSE}
## Add your code here
check_fev1_age <- function(dataset, plot = TRUE) {
  if(!all(c("fev1", "age") %in% names(dataset))) {
    stop("Dataset must contain 'FEV1' and 'age' columns.")
  }
  
  df <- dataset[complete.cases(dataset$fev1, dataset$age), ]
  
  if(nrow(df) < 2) {
    return(list(
      result = FALSE,
      model = NULL,
      plot = NULL
    ))
  }
  
  # Fit linear regression
  model <- lm(fev1 ~ age, data = df)
  
  slope <- coef(model)["age"]
  
  # Make plot
  p <- NULL
  if (plot) {
    library(ggplot2)
    p <- ggplot(df, aes(x = age, y = fev1)) +
      geom_point(alpha = 0.6, color = "steelblue") +
      geom_smooth(method = "lm", se = TRUE, color = "darkred") +
      labs(
        title = "Relationship between Age and FEV1",
        x = "Age (years)",
        y = "FEV1"
      ) +
      theme_minimal()
  }
  
  # Return result, model, and plot
  return(list(
    result = slope > 0,
    model = model,
    plot = p
  ))
}
out <- check_fev1_age(dataset)
out$result          
summary(out$model)  
print(out$plot) 
```


Write your data analysis statement interpreting the regression model here:

Based on the upwards slope shown in the linear regression model, as children grow older, they tend to have higher FEV1.  


## Part 3

Develop **three** supporting premises derived from the data that support the statement you wrote in Part 2. These can be plots, other summary statistics, or model results. 

NOTE: 

* At least one supporting premise should use a plot.

* Do not use the code you write in Part 1 as a supporting premise

```{r, warning = FALSE, message = FALSE}
## Add your code here

# Here is the estimand of the expected change in FEV1 for a one-year increase in age
coef(out$model)["age"]

# Here is another plot
df_summary <- dataset %>%
  group_by(age) %>%
  summarise(
    mean_FEV1 = mean(fev1, na.rm = TRUE),
    se_FEV1 = sd(fev1, na.rm = TRUE) / sqrt(n())
  )

ggplot(df_summary, aes(x = age, y = mean_FEV1)) +
  geom_point(color = "darkred", size = 2) +
  geom_line(color = "darkred") +
  geom_errorbar(aes(ymin = mean_FEV1 - se_FEV1, ymax = mean_FEV1 + se_FEV1),
                width = 0.2, color = "black") +
  labs(
    title = "Average FEV1 by Age (with SE bars)",
    x = "Age (years)",
    y = "Mean FEV1"
  ) +
  theme_minimal()

# Correlation (strength of association)
cor(dataset$age, dataset$fev1, use = "complete.obs")

```


Write the three supporting premise statements here:

1. For each additional year of age, FEV1 increases on average by 0.171 liters, based on the calculated expected change.

2. The visualization of mean FEV1 by age with error bars shows the upward trend more clearly, as FEV1 increases with age. 

3. The correlation coefficient of the relationship between age and FEV1 is 0.805, which is greater than 0.5, indicating a strong relationship between the two variables. So, age greatly affects FEV1.


## Part 4

For each of the supporting premises above, write a function that takes the `dataset` object as an argument and returns `TRUE` if the supporting premise statement above is true for the dataset and `FALSE` otherwise. 

For statements involving plots, instead of returning `TRUE` or `FALSE`, you function should do two things:

1. Produce the plot that is used in the statement

2. Produce a hypothetical version of the plot in the event that the statement is true. This can be done using simulated data or by simply hand drawing a plot.


```{r}
## Function for supporting premise statement 1
check_slope <- function(dataset) {
  model <- lm(fev1 ~ age, data = dataset)
  slope <- coef(model)["age"]
  
  # Check if slope equals 0.171 (within tolerance, since exact equality is unlikely)
  return(abs(slope - 0.171) < 1e-3)
}
check_slope(dataset)
```


```{r, warning = FALSE, message = FALSE}
## Function for supporting premise statement 2
check_visualization <- function(dataset) {
  library(dplyr)
  library(ggplot2)
  
  # Summarize data
  df_summary <- dataset %>%
    group_by(age) %>%
    summarise(
      mean_FEV1 = mean(fev1, na.rm = TRUE),
      se_FEV1   = sd(fev1, na.rm = TRUE) / sqrt(n())
    )
  
  # Actual plot
  p1 <- ggplot(df_summary, aes(x = age, y = mean_FEV1)) +
    geom_point(color = "darkred", size = 2) +
    geom_line(color = "darkred") +
    geom_errorbar(aes(ymin = mean_FEV1 - se_FEV1, ymax = mean_FEV1 + se_FEV1),
                  width = 0.2, color = "black") +
    labs(
      title = "Observed: Mean FEV1 by Age (with SE bars)",
      x = "Age (years)", y = "Mean FEV1"
    ) +
    theme_minimal()
  
  # Hypothetical plot (perfect upward trend of 0.171 per year)
  age_vals <- sort(unique(dataset$age))
  sim_data <- data.frame(
    age = age_vals,
    mean_FEV1 = 1 + 0.171 * (age_vals - min(age_vals))
  )
  
  p2 <- ggplot(sim_data, aes(x = age, y = mean_FEV1)) +
    geom_line(color = "blue") +
    geom_point(color = "blue", size = 2) +
    labs(
      title = "Hypothetical: Perfect Upward Trend (0.171 per year)",
      x = "Age (years)", y = "Mean FEV1"
    ) +
    theme_minimal()
  
  return(list(actual_plot = p1, hypothetical_plot = p2))
}
plots <- check_visualization(dataset)
print(plots$actual_plot)       # actual plot
print(plots$hypothetical_plot)
```


```{r}
## Function for supporting premise statement 3
check_correlation <- function(dataset) {
  cor_val <- cor(dataset$age, dataset$fev1, use = "complete.obs")
  
  # Check if correlation matches 0.805 (within tolerance) and is > 0.5
  return((abs(cor_val - 0.805) < 1e-3) & (cor_val > 0.5))
}
check_correlation(dataset)
```

Execute each of your function and show that the produce the expected output.




## Part 5

Describe one alternative to the primary statement "FEV1 values in children are higher in older children relative to younger children". 

Create a fault tree for the alternative outcome describing how the alternative outcome could be realized in the data even if the primary statement were true.

Your fault tree should be created as a separate image and does not need to be created in R. Upload the image of the fault tree to Canvas.


